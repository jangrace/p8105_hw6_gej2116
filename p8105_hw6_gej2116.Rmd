---
title: "Homework 6"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(viridis)
library(p8105.datasets)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 2

## Clean Data

1. Load data
2. Create following variables:
   * city_state
   * case_solved: binary variable where 0 = case unresolved, 1 = case resolved
3. Filter the data in the following ways:
   * For city_state, remove Dallax, TX; Phoenix, AZ; Kansas City, MO; Tulsa, AL
   * For victim_race, only includ White & Black
5. Convert victim_age's data type from char to numeric
6. Skim data

```{r data_clean}
homicide_df = read.csv('data/homicide.csv') %>% 
  janitor::clean_names() %>% 
  mutate(city_state = str_c(city, state, sep = ", "),
         case_solved = as.numeric(case_when(
           disposition == "Closed without arrest" ~ "0",
           disposition == "Open/No arrest" ~ "0",
           disposition == "Closed by arrest" ~ "1"))) %>% 
  filter(city_state != "Dallas, TX", 
         city_state != "Phoenix, AZ", 
         city_state != "Kansas City, MO", 
         city_state != "Tulsa, AL", 
         victim_race %in% c("White" ,"Black")) %>% 
  mutate(victim_age = as.numeric(victim_age))
```

```{r skim, include = FALSE}
skimr::skim(homicide_df)
```


## Baltimore, MD: GLM

1. Create a new data frame called "baltimore_df"
```{r baltimore_df}
homicide_baltimore = homicide_df %>% 
  filter(city_state == "Baltimore, MD")
```

2. Fit a log reg (outcome = case_solved, predictors = age, sex, race)
3. Save glm output
4. Find CI & estimate for odds ratio for male vs. female (victim_sexMale row) while keeping all other var
```{r glm}
baltimore_log_fit = 
  homicide_baltimore %>% 
  glm(case_solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 

summary(baltimore_log_fit)

baltimore_log_fit %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         OR_CI_lower = exp(estimate - 1.96*(std.error)),
         OR_CI_upper = exp(estimate + 1.96*(std.error))) %>% 
  select(term, log_OR = estimate, OR, OR_CI_lower, OR_CI_upper, p.value) %>% 
  knitr::kable()
```

## GLM for Each City

Run the test for all cities & find OR, including 95% CI
```{r glm_all}
homicide_df %>% 
  glm(case_solved ~ victim_age + victim_race + victim_sex, data = .) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)

homicide_df %>% 
  group_by(city_state) %>% 
  summarise(total = n())

homicide_log_fit =
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(.x = data, ~glm(case_solved ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)) %>% 
  unnest(results) %>% 
    filter(term == "victim_sexMale") %>% 
    mutate(OR = exp(estimate),
           OR_CI_lower = exp(estimate - 1.96*(std.error)),
           OR_CI_upper = exp(estimate + 1.96*(std.error))) %>%
    select(city_state, OR, OR_CI_lower, OR_CI_upper)

knitr::kable(homicide_log_fit)
```

## Plot Resolved Homicide Cases in Each City (Male vs. Female)

```{r plot}
homicide_plot = homicide_log_fit %>% 
  mutate(
    city_state = fct_reorder(city_state, OR)
  ) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = OR_CI_lower, ymax = OR_CI_upper)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(
    title = "OR for Solving Homicide Cases in the US (Male vs. Female Victims)",
    x = "Location (city, state)",
    y = "Adjusted OR")

homicide_plot
```

This plot displays estimated ORs and CIs for solving homicide cases in each city. Based on the plot, the odds of resolving homicides with female vs. male plot based on city, state can be summarized as follows:  
Cities with nearly equal odds ratio (OR =~ 1):  
* Atlanta, GA  
* Richmond, VA  
Cities where OR, male > OR, female (OR > 1):  
* Nashville, TN  
* Fresno, CA  
* Stockton, CA  
* Albuquerque, NM  
For all other cities, the odds of solving homicide cases with female victim is higher than the odds of solving homicide cases with male victims.