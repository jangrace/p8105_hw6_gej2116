Homework 6
================

# Problem 2

## Clean Data

1.  Load data
2.  Create following variables:
    -   city_state
    -   case_solved: binary variable where 0 = case unresolved, 1 = case
        resolved
3.  Filter the data in the following ways:
    -   For city_state, remove Dallax, TX; Phoenix, AZ; Kansas City, MO;
        Tulsa, AL
    -   For victim_race, only includ White & Black
4.  Convert victim_age’s data type from char to numeric
5.  Skim data

``` r
homicide_df = read.csv('data/homicide.csv') %>% 
  janitor::clean_names() %>% 
  mutate(city_state = str_c(city, state, sep = ", "),
         case_solved = as.numeric(case_when(
           disposition == "Closed without arrest" ~ "0",
           disposition == "Open/No arrest" ~ "0",
           disposition == "Closed by arrest" ~ "1"))) %>% 
  filter(city_state != "Dallas, TX", 
         city_state != "Phoenix, AZ", 
         city_state != "Kansas City, MO", 
         city_state != "Tulsa, AL", 
         victim_race %in% c("White" ,"Black")) %>% 
  mutate(victim_age = as.numeric(victim_age))
```

## Baltimore, MD: GLM

1.  Create a new data frame called “baltimore_df”

``` r
homicide_baltimore = homicide_df %>% 
  filter(city_state == "Baltimore, MD")
```

2.  Fit a log reg (outcome = case_solved, predictors = age, sex, race)
3.  Save glm output
4.  Find CI & estimate for odds ratio for male vs. female
    (victim_sexMale row) while keeping all other var

``` r
baltimore_log_fit = 
  homicide_baltimore %>% 
  glm(case_solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 

summary(baltimore_log_fit)
```

    ## 
    ## Call:
    ## glm(formula = case_solved ~ victim_age + victim_race + victim_sex, 
    ##     family = binomial(), data = .)
    ## 
    ## Deviance Residuals: 
    ##     Min       1Q   Median       3Q      Max  
    ## -1.6223  -0.8958  -0.8688   1.4699   1.6579  
    ## 
    ## Coefficients:
    ##                   Estimate Std. Error z value Pr(>|z|)    
    ## (Intercept)       0.309981   0.171295   1.810   0.0704 .  
    ## victim_age       -0.006727   0.003324  -2.024   0.0430 *  
    ## victim_raceWhite  0.841756   0.174716   4.818 1.45e-06 ***
    ## victim_sexMale   -0.854463   0.138176  -6.184 6.26e-10 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## (Dispersion parameter for binomial family taken to be 1)
    ## 
    ##     Null deviance: 3567.9  on 2752  degrees of freedom
    ## Residual deviance: 3492.7  on 2749  degrees of freedom
    ## AIC: 3500.7
    ## 
    ## Number of Fisher Scoring iterations: 4

``` r
baltimore_log_fit %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         OR_CI_lower = exp(OR - 1.96*(std.error)),
         OR_CI_upper = exp(OR + 1.96*(std.error))) %>% 
  select(term, log_OR = estimate, OR, OR_CI_lower, OR_CI_upper, p.value) %>% 
  knitr::kable()
```

| term             |     log_OR |        OR | OR_CI_lower | OR_CI_upper |   p.value |
|:-----------------|-----------:|----------:|------------:|------------:|----------:|
| (Intercept)      |  0.3099810 | 1.3633992 |    2.794523 |    5.469226 | 0.0703525 |
| victim_age       | -0.0067272 | 0.9932953 |    2.682586 |    2.717764 | 0.0429574 |
| victim_raceWhite |  0.8417563 | 2.3204389 |    7.228237 |   14.337558 | 0.0000015 |
| victim_sexMale   | -0.8544628 | 0.4255117 |    1.167292 |    2.006390 | 0.0000000 |

## GLM for Each City

Run the test for all cities & find OR, including 95% CI

``` r
homicide_df %>% 
  glm(case_solved ~ victim_age + victim_race + victim_sex, data = .) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)
```

| term              | estimate | std.error | statistic | p.value |
|:------------------|---------:|----------:|----------:|--------:|
| (Intercept)       |    0.586 |     0.009 |    66.381 |   0.000 |
| victim_age        |   -0.001 |     0.000 |    -2.941 |   0.003 |
| victim_raceWhite  |    0.147 |     0.007 |    20.759 |   0.000 |
| victim_sexMale    |   -0.123 |     0.007 |   -17.220 |   0.000 |
| victim_sexUnknown |   -0.017 |     0.078 |    -0.214 |   0.831 |

``` r
homicide_df %>% 
  group_by(city_state) %>% 
  summarise(total = n())
```

    ## # A tibble: 47 × 2
    ##    city_state      total
    ##    <chr>           <int>
    ##  1 Albuquerque, NM   178
    ##  2 Atlanta, GA       945
    ##  3 Baltimore, MD    2753
    ##  4 Baton Rouge, LA   410
    ##  5 Birmingham, AL    771
    ##  6 Boston, MA        492
    ##  7 Buffalo, NY       479
    ##  8 Charlotte, NC     584
    ##  9 Chicago, IL      4507
    ## 10 Cincinnati, OH    679
    ## # … with 37 more rows

``` r
homicide_log_fit =
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(.x = data, ~glm(case_solved ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)) %>% 
  unnest(results) %>% 
    filter(term == "victim_sexMale") %>% 
    mutate(OR = exp(estimate),
           OR_CI_lower = exp(OR - 1.96*(std.error)),
           OR_CI_upper = exp(OR + 1.96*(std.error))) %>%
    select(city_state, OR, OR_CI_lower, OR_CI_upper) 

homicide_log_fit
```

    ## # A tibble: 47 × 4
    ##    city_state         OR OR_CI_lower OR_CI_upper
    ##    <chr>           <dbl>       <dbl>       <dbl>
    ##  1 Albuquerque, NM 1.77        2.75        12.5 
    ##  2 Atlanta, GA     1.00        1.86         3.98
    ##  3 Baltimore, MD   0.426       1.17         2.01
    ##  4 Baton Rouge, LA 0.381       0.803        2.67
    ##  5 Birmingham, AL  0.870       1.58         3.62
    ##  6 Boston, MA      0.674       1.04         3.71
    ##  7 Buffalo, NY     0.521       0.937        3.02
    ##  8 Charlotte, NC   0.884       1.53         3.84
    ##  9 Chicago, IL     0.410       1.23         1.84
    ## 10 Cincinnati, OH  0.400       0.881        2.53
    ## # … with 37 more rows
